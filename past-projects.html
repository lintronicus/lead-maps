// Initialize the map when the document is ready
document.addEventListener('DOMContentLoaded', function() {
  // Initialize markers array outside the function
  let markers = [];
  
  mapboxgl.accessToken = 'pk.eyJ1IjoibGVhZHN5ZnRlciIsImEiOiJjbTd2Z2k3MjYwYjFvMnFvZHd0NmE4M3pvIn0.xHYtpfn9dQa7CZOoY29-cA';
  
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-118.65, 34.15],
    zoom: 13
  });

  // Fetch the timestamp from the URL (e.g., ?t=1636160712310)
  const timestamp = new URLSearchParams(window.location.search).get('t');

  if (!timestamp) {
    document.getElementById('error').textContent = 'Timestamp parameter missing';
    document.getElementById('loading').style.display = 'none';
    return;  // Return here to prevent further execution if no timestamp is found
  }

  // Construct the URL for the latest JSON file based on the timestamp
  const jsonUrl = `https://raw.githubusercontent.com/lintronicus/images/main/data/projects_${timestamp}.json`;

  console.log("Fetching JSON from: " + jsonUrl); // Debugging log

  // Function to create a Google Maps navigation URL
  function createGoogleMapsUrl(coords, name) {
    const baseUrl = 'https://www.google.com/maps/dir/?api=1';
    const destination = `${coords[1]},${coords[0]}`; // Google Maps uses lat, lng
    const destinationName = encodeURIComponent(name || 'Property');
    return `${baseUrl}&destination=${destination}&travelmode=driving&destination_place_name=${destinationName}`;
  }

  // Function to create a Street View URL
  function createStreetViewUrl(panoLat, panoLng, heading) {
    if (!panoLat || !panoLng) return null;
    return `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${panoLat},${panoLng}${heading ? `&heading=${heading}` : ''}`;
  }

  // Function to generate the popup HTML for each marker
  function createPopupHTML(props, coords) {
    const name = props["project_name"] || "Unnamed";
    const address = props["project_address"] || "No address provided";
    const photoUrl = props["photo_url"];
    const panoLat = props["pano_latitude"];
    const panoLng = props["pano_longitude"];
    const heading = props["heading"];
    const googleMapsUrl = createGoogleMapsUrl(coords, name);
    const streetViewUrl = createStreetViewUrl(panoLat, panoLng, heading);

    const imageHtml = (photoUrl && streetViewUrl)
      ? ` 
        <div style="margin-top:10px; margin-bottom:10px; max-height:180px; overflow:hidden;">
          <a href="${streetViewUrl}" target="_blank" rel="noopener noreferrer">
            <img src="${photoUrl}" 
                 alt="Photo of ${name}" 
                 loading="lazy">
          </a>
        </div>`
      : "";

    return `
      <div class="property-popup">
        <h3>${name}</h3>
        ${imageHtml}
        <p><strong>Address:</strong> ${address}</p>
        <a href="${googleMapsUrl}" class="nav-link" target="_blank">Navigate in Google Maps</a>
      </div>
    `;
  }

  // Function to add markers to the map
  function addMarkersToMap(geojson) {
    markers.forEach(marker => marker.remove());
    markers = [];

    geojson.features.forEach(feature => {
      const coords = feature.geometry.coordinates;
      const props = feature.properties;

      const popup = new mapboxgl.Popup({ offset: 25 })
        .setHTML(createPopupHTML(props, coords));

      const marker = new mapboxgl.Marker({ color: '#3887be' })
        .setLngLat(coords)
        .setPopup(popup)
        .addTo(map);

      markers.push(marker);
    });
  }

  // Fetch the data and add markers
  fetch(jsonUrl)
    .then(res => {
      if (!res.ok) {
        throw new Error('Failed to fetch JSON: ' + res.statusText);
      }
      return res.json();
    })
    .then(data => {
      console.log("Data loaded successfully:", data); // Debugging log

      // Parse and add the data to the map
      const geojsonData = {
        type: "FeatureCollection",
        features: data.map(item => ({
          type: "Feature",
          properties: {
            project_name: item.project_name,
            project_address: item.project_address,
            photo_url: item.photo_url,
            pano_latitude: parseFloat(item.pano_latitude),
            pano_longitude: parseFloat(item.pano_longitude),
            heading: parseFloat(item.heading)
          },
          geometry: {
            type: "Point",
            coordinates: [parseFloat(item.longitude), parseFloat(item.latitude)]
          }
        }))
      };

      // Add markers to the map
      addMarkersToMap(geojsonData);
      document.getElementById('loading').style.display = 'none';
    })
    .catch(err => {
      document.getElementById('error').textContent = "Error loading map data: " + err.message;
      console.error("Error loading JSON:", err);
      document.getElementById('loading').style.display = 'none';
    });

  // Map event handlers
  map.on('load', function() {
    if (!timestamp) {
      document.getElementById('error').textContent = 'Timestamp parameter missing';
      document.getElementById('loading').style.display = 'none';
    }
  });

  map.on('error', function(e) {
    document.getElementById('error').textContent = 'Map error: ' + e.error.message;
    document.getElementById('loading').style.display = 'none';
  });

  // Add map style selector functionality
  document.getElementById('map-style').addEventListener('change', function() {
    map.setStyle(this.value);
  });
});
