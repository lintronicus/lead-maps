<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Property Map Viewer</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .mapboxgl-popup { max-width: 400px; font-family: sans-serif; }
    .mapboxgl-popup-content { padding: 15px; }
    .property-popup h3 { margin: 0 0 10px 0; }
    .property-popup p { margin: 5px 0; }
    .lead-name { color: #3887be; font-weight: bold; }
    #loading { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(255,255,255,0.9); 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      font-family: sans-serif;
    }
    #error { color: red; margin-top: 20px; text-align: center; max-width: 80%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">
    <div>Loading property data...</div>
    <div id="error"></div>
  </div>

  <script>
    try {
      // Set your Mapbox access token
      mapboxgl.accessToken = 'pk.eyJ1IjoibGVhZHN5ZnRlciIsImEiOiJjbTd2Z2k3MjYwYjFvMnFvZHd0NmE4M3pvIn0.xHYtpfn9dQa7CZOoY29-cA';
      
      document.getElementById('error').textContent = 'Checking Mapbox token...';
      
      if (!mapboxgl.accessToken) {
        throw new Error('Mapbox token is not set');
      }
      
      document.getElementById('error').textContent = 'Initializing map...';
      
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [-118.65, 34.15],
        zoom: 13
      });
      
      document.getElementById('error').textContent = 'Map initialized, loading data...';
      
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('data');
      
      map.on('load', function() {
        document.getElementById('error').textContent = 'Map loaded, processing data...';
        
        if (!encodedData) {
          document.getElementById('error').textContent = 'No data parameter found in URL';
          return;
        }
        
        try {
          const jsonString = decodeURIComponent(encodedData);
          const geojson = JSON.parse(jsonString);
          
          document.getElementById('error').textContent = 'Data parsed, adding to map...';
          
          if (!geojson.features || geojson.features.length === 0) {
            document.getElementById('error').textContent = 'No features found in data';
            return;
          }
          
          document.getElementById('error').textContent = `Found ${geojson.features.length} properties`;
          
          // Helper function to create popup HTML with Lead/Deal Name
          function createPopupHTML(props) {
            let leadNameHTML = '';
            if (props["Lead/Deal Name"]) {
              leadNameHTML = `<p class="lead-name"><strong>Lead/Deal:</strong> ${props["Lead/Deal Name"]}</p>`;
            }
            
            return `
              <div class="property-popup">
                <h3>${props["Property Name"] || "Property"}</h3>
                <p><strong>Address:</strong> ${props["Street Address"] || "N/A"}</p>
                <p><strong>Asset Class:</strong> ${props["Asset Class"] || "N/A"}</p>
                <p><strong>Sq Ft:</strong> ${(props["Sq Ft"] || 0).toLocaleString()}</p>
                <p><strong>Units:</strong> ${props["# Units"] || 0}</p>
                ${leadNameHTML}
              </div>
            `;
          }
          
          // Special handling for single property vs multiple properties
          if (geojson.features.length === 1) {
            // For a single property, use direct center and fixed zoom
            const feature = geojson.features[0];
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            
            // Set center and zoom directly
            map.jumpTo({
              center: coords,
              zoom: 14  // Fixed zoom level for single property
            });
            
            // Add marker with popup
            const popup = new mapboxgl.Popup({ offset: 25 })
              .setHTML(createPopupHTML(props));
            
            new mapboxgl.Marker({ color: '#3887be' })
              .setLngLat(coords)
              .setPopup(popup)
              .addTo(map);
          } else {
            // For multiple properties, use bounds calculation
            let sumLat = 0;
            let sumLng = 0;
            let minLng = 180;
            let maxLng = -180;
            let minLat = 90;
            let maxLat = -90;
            
            geojson.features.forEach(feature => {
              const coords = feature.geometry.coordinates;
              const lng = coords[0];
              const lat = coords[1];
              
              sumLat += lat;
              sumLng += lng;
              
              minLng = Math.min(minLng, lng);
              maxLng = Math.max(maxLng, lng);
              minLat = Math.min(minLat, lat);
              maxLat = Math.max(maxLat, lat);
            });
            
            // Calculate appropriate zoom level
            const lngDiff = Math.abs(maxLng - minLng);
            const latDiff = Math.abs(maxLat - minLat);
            let zoom = 14; // Default zoom
            
            if (lngDiff > 0.1 || latDiff > 0.1) {
              zoom = 12; // Zoom out for wider areas
            } else if (lngDiff > 0.01 || latDiff > 0.01) {
              zoom = 13; // Medium zoom for medium areas
            }
            
            // Create bounds and fit map to them
            const sw = [minLng, minLat];
            const ne = [maxLng, maxLat];
            const bounds = new mapboxgl.LngLatBounds(sw, ne);
            
            map.fitBounds(bounds, {
              padding: {top: 100, bottom: 100, left: 100, right: 100},
              maxZoom: zoom
            });
            
            // Add markers for each property
            geojson.features.forEach(feature => {
              const coords = feature.geometry.coordinates;
              const props = feature.properties;
              
              const popup = new mapboxgl.Popup({ offset: 25 })
                .setHTML(createPopupHTML(props));
              
              new mapboxgl.Marker({ color: '#3887be' })
                .setLngLat(coords)
                .setPopup(popup)
                .addTo(map);
            });
          }
          
          // Hide loading indicator
          document.getElementById('loading').style.display = 'none';
        } catch (e) {
          document.getElementById('error').textContent = 'Error processing data: ' + e.message;
        }
      });
      
      map.on('error', function(e) {
        document.getElementById('error').textContent = 'Map error: ' + e.error.message;
      });
    } catch (e) {
      document.getElementById('error').textContent = 'Error: ' + e.message;
    }
  </script>
</body>
</html>
