let extractedFeatures = [];
let debugLog = [];

debugLog.push(`Input type: ${typeof input}`);

if (Array.isArray(input)) {
  debugLog.push(`Processing array with ${input.length} items`);
  
  input.forEach((property, index) => {
    if (property && property.Latitude && property.Longitude) {
      debugLog.push(`Processing property ${index + 1}: ${property["Property Name"] || "Unnamed"}`);
      
      extractedFeatures.push({
        "type": "Feature",
        "properties": {
          "Property Name": property["Property Name"] || "",
          "Simple Address": property["Simple Address"] || property["Property Name"] || "",
          "Lead Name": property["Lead Name"] || "",
          "Asset Class": property["Asset Class"] || "",
          "Sq Ft": property["Sq Ft"] || "0",
          "Units": property["Units"] || "0"
        },
        "geometry": {
          "type": "Point",
          "coordinates": [
            parseFloat(property["Longitude"]),
            parseFloat(property["Latitude"])
          ]
        }
      });
      
      debugLog.push(`Added feature for ${property["Property Name"] || "Unnamed"}`);
    } else {
      debugLog.push(`Property ${index + 1} missing coordinates`);
    }
  });
} 
else if (typeof input === 'string') {
  debugLog.push(`Processing string input: ${input.substring(0, 100)}...`);
  
  try {
    let jsonData;
    
    try {
      jsonData = JSON.parse(input);
    } catch (e) {
      debugLog.push(`Not valid JSON: ${e.message}`);
      jsonData = null;
    }
    
    if (jsonData) {
      debugLog.push("Successfully parsed JSON data");
      
      if (Array.isArray(jsonData)) {
        jsonData.forEach((property, index) => {
          if (property && property.Latitude && property.Longitude) {
            extractedFeatures.push({
              "type": "Feature",
              "properties": {
                "Property Name": property["Property Name"] || "",
                "Simple Address": property["Simple Address"] || property["Property Name"] || "",
                "Lead Name": property["Lead Name"] || "",
                "Asset Class": property["Asset Class"] || "",
                "Sq Ft": property["Sq Ft"] || "0",
                "Units": property["Units"] || "0"
              },
              "geometry": {
                "type": "Point",
                "coordinates": [
                  parseFloat(property["Longitude"]),
                  parseFloat(property["Latitude"])
                ]
              }
            });
            
            debugLog.push(`Added feature for ${property["Property Name"] || "Unnamed"}`);
          }
        });
      } 
      else if (jsonData.Latitude && jsonData.Longitude) {
        extractedFeatures.push({
          "type": "Feature",
          "properties": {
            "Property Name": jsonData["Property Name"] || "",
            "Simple Address": jsonData["Simple Address"] || jsonData["Property Name"] || "",
            "Lead Name": jsonData["Lead Name"] || "",
            "Asset Class": jsonData["Asset Class"] || "",
            "Sq Ft": jsonData["Sq Ft"] || "0",
            "Units": jsonData["Units"] || "0"
          },
          "geometry": {
            "type": "Point",
            "coordinates": [
              parseFloat(jsonData["Longitude"]),
              parseFloat(jsonData["Latitude"])
            ]
          }
        });
        
        debugLog.push(`Added feature for ${jsonData["Property Name"] || "Unnamed"}`);
      }
    }
  } catch (e) {
    debugLog.push(`Error in string processing: ${e.message}`);
  }
}

debugLog.push(`Total features created: ${extractedFeatures.length}`);

const featureCollection = {
  "type": "FeatureCollection",
  "features": extractedFeatures
};

const timestamp = Date.now();
const encodedData = encodeURIComponent(JSON.stringify(featureCollection));
const mapUrl = `https://lintronicus.github.io/lead-maps/?t=${timestamp}&data=${encodedData}`;

return {
  url: mapUrl,
  featuresFound: extractedFeatures.length,
  debugLog: debugLog,
  sampleFeature: extractedFeatures.length > 0 ? extractedFeatures[0] : null
};
