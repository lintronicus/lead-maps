<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Property Map Viewer</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .mapboxgl-popup { max-width: 400px; font-family: sans-serif; }
    .mapboxgl-popup-content { padding: 15px; }
    .property-popup h3 { margin: 0 0 10px 0; }
    .property-popup p { margin: 5px 0; }
    #loading { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(255,255,255,0.9); 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 999;
      font-family: sans-serif;
    }
    #error { color: red; margin-top: 20px; text-align: center; max-width: 80%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">
    <div>Loading property data...</div>
    <div id="error"></div>
  </div>

  <script>
    try {
      // Set your Mapbox access token
      mapboxgl.accessToken = 'pk.eyJ1IjoibGVhZHN5ZnRlciIsImEiOiJjbTd2Z2k3MjYwYjFvMnFvZHd0NmE4M3pvIn0.xHYtpfn9dQa7CZOoY29-cA';
      
      document.getElementById('error').textContent = 'Checking Mapbox token...';
      
      // Fixed validation logic
      if (!mapboxgl.accessToken) {
        throw new Error('Mapbox token is not set');
      }
      
      document.getElementById('error').textContent = 'Initializing map...';
      
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [-118.65, 34.15],
        zoom: 13
      });
      
      document.getElementById('error').textContent = 'Map initialized, loading data...';
      
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('data');
      
      map.on('load', function() {
        document.getElementById('error').textContent = 'Map loaded, processing data...';
        
        if (!encodedData) {
          document.getElementById('error').textContent = 'No data parameter found in URL';
          return;
        }
        
        try {
          const jsonString = decodeURIComponent(encodedData);
          const geojson = JSON.parse(jsonString);
          
          document.getElementById('error').textContent = 'Data parsed, adding to map...';
          
          if (!geojson.features || geojson.features.length === 0) {
            document.getElementById('error').textContent = 'No features found in data';
            return;
          }
          
          document.getElementById('error').textContent = `Found ${geojson.features.length} properties`;
          
          // Calculate bounds
          const bounds = new mapboxgl.LngLatBounds();
          geojson.features.forEach(feature => {
            bounds.extend(feature.geometry.coordinates);
          });
          
          // Add markers
          geojson.features.forEach(feature => {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            
            const popup = new mapboxgl.Popup({ offset: 25 })
              .setHTML(`
                <div class="property-popup">
                  <h3>${props["Property Name"] || "Property"}</h3>
                  <p><strong>Address:</strong> ${props["Street Address"] || "N/A"}</p>
                  <p><strong>Asset Class:</strong> ${props["Asset Class"] || "N/A"}</p>
                  <p><strong>Sq Ft:</strong> ${(props["Sq Ft"] || 0).toLocaleString()}</p>
                  <p><strong>Units:</strong> ${props["# Units"] || 0}</p>
                </div>
              `);
            
            new mapboxgl.Marker({ color: '#3887be' })
              .setLngLat(coords)
              .setPopup(popup)
              .addTo(map);
          });
          
          // Fit map to show all properties
          map.fitBounds(bounds, { padding: 50 });
          
          // Hide loading indicator
          document.getElementById('loading').style.display = 'none';
        } catch (e) {
          document.getElementById('error').textContent = 'Error processing data: ' + e.message;
        }
      });
      
      map.on('error', function(e) {
        document.getElementById('error').textContent = 'Map error: ' + e.error.message;
      });
    } catch (e) {
      document.getElementById('error').textContent = 'Error: ' + e.message;
    }
  </script>
</body>
</html>
